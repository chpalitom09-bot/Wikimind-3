<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiMind AI • Cognitive Interface</title>
    
    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Markdown Parsing & Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        glass: { panel: 'rgba(20, 20, 20, 0.6)', border: 'rgba(255, 255, 255, 0.08)' },
                        brand: { 500: '#6366f1', 600: '#4f46e5', glow: '#818cf8' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: 0, transform: 'translateY(10px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #ffffff; overflow: hidden; }
        .glass-panel {
            background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.8em; }
        .prose pre { background: #1a1a1a; padding: 1em; border-radius: 0.5em; overflow-x: auto; border: 1px solid rgba(255,255,255,0.1); }
        .prose code { font-family: 'Courier New', monospace; color: #a5a6f6; }
        .prose strong { color: #fff; font-weight: 700; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose a { color: #6366f1; text-decoration: underline; }
    </style>
</head>
<body class="selection:bg-brand-500 selection:text-white h-screen flex flex-col">

    <!-- AURORA BG -->
    <canvas id="aurora-bg" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

    <!-- AUTH OVERLAY (Visible if not logged in) -->
    <div id="auth-overlay" class="fixed inset-0 z-50 bg-[#050505] flex items-center justify-center">
        <div class="text-center space-y-6 p-8 glass-panel rounded-3xl max-w-md w-full mx-4 border border-brand-500/30">
            <div class="w-16 h-16 bg-brand-500 rounded-2xl mx-auto flex items-center justify-center text-3xl font-bold animate-pulse">W</div>
            <h1 class="text-3xl font-display font-bold">WikiMind AI</h1>
            <p class="text-white/60">Accès sécurisé au réseau neuronal requis.</p>
            <a href="Wikimind_user.html" class="block w-full py-3 bg-white text-black font-bold rounded-xl hover:bg-brand-glow hover:text-white transition-all">
                CONNEXION SYSTÈME
            </a>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-container" class="flex h-full hidden opacity-0 transition-opacity duration-1000">
        
        <!-- SIDEBAR (Desktop) -->
        <aside class="hidden md:flex flex-col w-72 glass-panel border-r border-white/5 m-4 rounded-3xl overflow-hidden">
            <div class="p-6 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gradient-to-tr from-white to-gray-400 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-black text-xs">W</span>
                    </div>
                    <span class="font-display font-bold text-lg">WikiMind <span class="text-brand-glow text-xs align-top">AI</span></span>
                </div>
            </div>

            <!-- Model Selector -->
            <div class="p-4">
                <label class="text-xs text-white/40 uppercase tracking-widest font-bold ml-2 mb-2 block">Modèle Neuronal</label>
                <div class="relative">
                    <select id="model-select" class="w-full appearance-none bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-brand-500 cursor-pointer">
                        <option value="core">WikiMind Core (Polyvalent)</option>
                        <option value="nexus">WikiMind Nexus (Logique)</option>
                        <option value="flash">WikiMind Flash (Rapide)</option>
                        <option value="canvas">WikiMind Canvas (Création)</option>
                    </select>
                    <div class="absolute right-4 top-3.5 pointer-events-none text-white/40">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-xs text-white/40 uppercase tracking-widest font-bold ml-2 mb-2">Historique Session</div>
                <div id="chat-history-list" class="space-y-1">
                    <!-- Les éléments d'historique seront injectés ici -->
                </div>
            </div>

            <div class="p-4 border-t border-white/5 bg-white/5">
                <div class="flex items-center gap-3">
                    <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-white/20">
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-bold truncate">Utilisateur</p>
                        <p class="text-[10px] text-green-400">● Système Connecté</p>
                    </div>
                    <button id="logout-btn" class="text-white/40 hover:text-white transition"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </aside>

        <!-- MAIN CHAT AREA -->
        <main class="flex-1 flex flex-col h-full relative">
            
            <!-- Mobile Header -->
            <header class="md:hidden flex items-center justify-between p-4 glass-panel m-2 rounded-2xl z-20">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 bg-white rounded-md flex items-center justify-center text-black text-xs font-bold">W</div>
                    <span class="font-display font-bold">WikiMind</span>
                </div>
                <select id="mobile-model-select" class="bg-white/10 border-none rounded-lg text-xs py-1 px-2 text-white focus:ring-0">
                    <option value="core">Core</option>
                    <option value="nexus">Nexus</option>
                    <option value="flash">Flash</option>
                    <option value="canvas">Canvas</option>
                </select>
            </header>

            <!-- Chat Content -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32">
                <!-- Welcome Message -->
                <div class="flex gap-4 max-w-3xl mx-auto animate-fade-in">
                    <div class="w-8 h-8 rounded-lg bg-brand-500 flex items-center justify-center shrink-0 mt-1">
                        <i class="fa-solid fa-brain text-white text-xs"></i>
                    </div>
                    <div class="glass-panel p-5 rounded-2xl rounded-tl-none border border-white/10">
                        <p class="text-sm md:text-base leading-relaxed">
                            <span class="text-brand-glow font-bold">WikiMind OS v3.1 initialisé.</span><br>
                            Je suis votre assistant cognitif unifié. Sélectionnez un module (Core, Nexus, Flash ou Canvas) et commencez l'interaction.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="absolute bottom-0 left-0 w-full p-4 md:p-6 bg-gradient-to-t from-[#050505] via-[#050505] to-transparent z-10">
                <div class="max-w-3xl mx-auto glass-panel p-2 rounded-2xl border border-white/10 relative">
                    <textarea id="user-input" rows="1" placeholder="Entrez votre commande neuronale..." 
                        class="w-full bg-transparent border-none text-white placeholder-white/40 focus:ring-0 resize-none max-h-32 py-3 px-4"
                        style="min-height: 50px;"></textarea>
                    
                    <div class="flex justify-between items-center px-2 pb-2">
                        <div class="flex gap-2">
                            <button id="btn-mode-indicator" class="text-[10px] uppercase font-bold px-2 py-1 rounded bg-brand-500/20 text-brand-glow border border-brand-500/30">
                                Core
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button id="send-btn" class="w-8 h-8 rounded-lg bg-brand-600 hover:bg-brand-500 flex items-center justify-center transition-all shadow-lg shadow-brand-500/20">
                                <i class="fa-solid fa-arrow-up text-white text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <p class="text-center text-[10px] text-white/20 mt-2 font-mono">WikiMind Secured Channel • End-to-End Encrypted</p>
            </div>

        </main>
    </div>

    <!-- LOGIC -->
    <script type="module">
        // --------------------------------------------------------
        // 1. CONFIGURATION & IMPORTS
        // --------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, get, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD6qIOtKSx0Sl1Ht_a6ppLiMdKZRCc75tA",
            authDomain: "wikimind-3-comments.firebaseapp.com",
            projectId: "wikimind-3-comments",
            storageBucket: "wikimind-3-comments.firebasestorage.app",
            messagingSenderId: "137479541640",
            appId: "1:137479541640:web:4ed2510a9908055052e03d",
            databaseURL: "https://wikimind-communauty-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --------------------------------------------------------
        // 2. SECURITY & KEYS (OBFUSCATION)
        // --------------------------------------------------------
        // Fonction de déchiffrement (décalage -1)
        function decodeKey(encoded) {
            if (!encoded) return "";
            return encoded.split('').map(char => String.fromCharCode(char.charCodeAt(0) - 1)).join('');
        }

        // Clés encodées (Caractère +1 par rapport aux vraies clés fournies)
        // Gemini: AIzaSyDa2c8QI2YrjW7aBdDZwK7wItMFs4d3PuA
        const coreKey = decodeKey("BJ{bTzEb3d9RJ3ZskX8bCeEAxL8xJuNGt5e4QvB"); 
        
        // Mistral: wqfdKpHeXqMy60uIeHhs0mpI2OJYFLHx
        const nexusKey = decodeKey("xrgeLqIfYrNz71vJfIit1nqJ3PKZGMIy"); 
        
        // Groq: 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
        const flashKey = decodeKey("htl`XKj73tr4XStmP5GUhe6HXHUzc4GZZvyV7G3cLyM42iEywJ66UmTuo"); 

        // --------------------------------------------------------
        // 3. UI STATE & ELEMENTS
        // --------------------------------------------------------
        const elements = {
            authOverlay: document.getElementById('auth-overlay'),
            appContainer: document.getElementById('app-container'),
            chatContainer: document.getElementById('chat-container'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            modelSelect: document.getElementById('model-select'),
            mobileModelSelect: document.getElementById('mobile-model-select'),
            modeIndicator: document.getElementById('btn-mode-indicator'),
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            logoutBtn: document.getElementById('logout-btn')
        };

        let currentUser = null;
        let currentModel = 'core'; // core, nexus, flash, canvas

        // --------------------------------------------------------
        // 4. AUTHENTICATION LOGIC
        // --------------------------------------------------------
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // UI Unlock
                elements.authOverlay.classList.add('hidden');
                elements.appContainer.classList.remove('hidden');
                setTimeout(() => elements.appContainer.classList.remove('opacity-0'), 100);
                
                // User Info
                const photoUrl = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=6366f1&color=fff`;
                elements.userAvatar.src = photoUrl;
                elements.userName.innerText = user.displayName || user.email.split('@')[0];

                // Load History
                loadChatHistory();
            } else {
                currentUser = null;
                elements.appContainer.classList.add('hidden');
                elements.appContainer.classList.add('opacity-0');
                elements.authOverlay.classList.remove('hidden');
            }
        });

        elements.logoutBtn.addEventListener('click', () => signOut(auth));

        // --------------------------------------------------------
        // 5. CHAT ENGINE
        // --------------------------------------------------------
        
        // Synchro selecteurs Desktop/Mobile
        function setModel(model) {
            currentModel = model;
            elements.modelSelect.value = model;
            elements.mobileModelSelect.value = model;
            elements.modeIndicator.innerText = model.toUpperCase();
            
            // Couleur indicateur selon modèle
            let colorClass = "text-brand-glow";
            if (model === 'nexus') colorClass = "text-yellow-400";
            if (model === 'flash') colorClass = "text-orange-400";
            if (model === 'canvas') colorClass = "text-pink-400";
            
            elements.modeIndicator.className = `text-[10px] uppercase font-bold px-2 py-1 rounded bg-white/5 border border-white/10 ${colorClass}`;
        }

        elements.modelSelect.addEventListener('change', (e) => setModel(e.target.value));
        elements.mobileModelSelect.addEventListener('change', (e) => setModel(e.target.value));

        // Auto-resize textarea
        elements.userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Send Logic
        async function handleSend() {
            const text = elements.userInput.value.trim();
            if (!text || !currentUser) return;

            // 1. UI Reset
            elements.userInput.value = '';
            elements.userInput.style.height = 'auto';

            // 2. Afficher message utilisateur
            appendMessage('user', text);
            saveToFirebase('user', text);

            // 3. Indicateur de chargement
            const loadingId = appendLoading();
            scrollToBottom();

            // 4. Routage IA
            try {
                let responseText = "";
                let isImage = false;

                if (currentModel === 'canvas') {
                    // POLLINATIONS AI (Image)
                    const encodedPrompt = encodeURIComponent(text);
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}`;
                    responseText = `![Génération Visuelle](${imageUrl})`;
                    isImage = true; // Pour le traitement spécial si besoin
                    
                    // Simulation délai réseau pour l'image
                    await new Promise(r => setTimeout(r, 1000));
                    
                } else if (currentModel === 'core') {
                    // GEMINI (Google)
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${coreKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "System: Tu es WikiMind Core, une IA avancée. Réponds de manière concise et futuriste.\nUser: " + text }] }]
                        })
                    });
                    const data = await response.json();
                    responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur neurale Gemini.";

                } else if (currentModel === 'nexus') {
                    // MISTRAL
                    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${nexusKey}`
                        },
                        body: JSON.stringify({
                            model: "mistral-tiny",
                            messages: [
                                { role: "system", content: "Tu es WikiMind Nexus. Une IA logique et précise." },
                                { role: "user", content: text }
                            ]
                        })
                    });
                    const data = await response.json();
                    responseText = data.choices?.[0]?.message?.content || "Erreur neurale Mistral.";

                } else if (currentModel === 'flash') {
                    // GROQ (Llama 3)
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${flashKey}`
                        },
                        body: JSON.stringify({
                            model: "llama3-8b-8192",
                            messages: [
                                { role: "system", content: "Tu es WikiMind Flash. Une IA ultra-rapide." },
                                { role: "user", content: text }
                            ]
                        })
                    });
                    const data = await response.json();
                    responseText = data.choices?.[0]?.message?.content || "Erreur neurale Groq.";
                }

                // 5. Remplacer loader par réponse
                removeMessage(loadingId);
                appendMessage('ai', responseText, currentModel);
                saveToFirebase('ai', responseText, currentModel);

            } catch (error) {
                console.error(error);
                removeMessage(loadingId);
                appendMessage('ai', "⚠️ Interruption du flux neuronal. Vérifiez vos clés API ou votre connexion.");
            }
        }

        elements.sendBtn.addEventListener('click', handleSend);
        elements.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // --------------------------------------------------------
        // 6. UI HELPERS (APPEND MESSAGES)
        // --------------------------------------------------------
        function scrollToBottom() {
            elements.chatContainer.scrollTo({ top: elements.chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function appendMessage(role, text, modelUsed = null) {
            const div = document.createElement('div');
            div.className = `flex gap-4 max-w-3xl mx-auto animate-fade-in ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            const isImage = text.includes('![Génération');
            
            // Avatar
            let avatarHtml = '';
            if (role === 'user') {
                avatarHtml = `<img src="${elements.userAvatar.src}" class="w-8 h-8 rounded-full border border-white/20 mt-1 object-cover">`;
            } else {
                let icon = 'brain';
                let color = 'bg-brand-500';
                if(modelUsed === 'nexus') { icon = 'server'; color = 'bg-yellow-600'; }
                if(modelUsed === 'flash') { icon = 'bolt'; color = 'bg-orange-600'; }
                if(modelUsed === 'canvas') { icon = 'palette'; color = 'bg-pink-600'; }
                
                avatarHtml = `<div class="w-8 h-8 rounded-lg ${color} flex items-center justify-center shrink-0 mt-1 shadow-[0_0_15px_rgba(99,102,241,0.3)]"><i class="fa-solid fa-${icon} text-white text-xs"></i></div>`;
            }

            // Content Parsing
            let contentHtml = '';
            if (role === 'ai' && !isImage) {
                contentHtml = marked.parse(text);
            } else if (isImage) {
                // Extraction URL markdown simple
                const url = text.match(/\((.*?)\)/)[1];
                contentHtml = `<img src="${url}" class="rounded-lg w-full max-w-md border border-white/10 shadow-2xl" onload="this.parentElement.scrollIntoView({behavior:'smooth'})">`;
            } else {
                contentHtml = `<p class="whitespace-pre-wrap">${text}</p>`;
            }

            div.innerHTML = `
                ${avatarHtml}
                <div class="${role === 'user' ? 'bg-brand-600/20 border-brand-500/30' : 'glass-panel border-white/10'} p-5 rounded-2xl ${role === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} border max-w-[85%] md:max-w-[75%]">
                    <div class="prose prose-invert prose-sm text-sm md:text-base leading-relaxed break-words">
                        ${contentHtml}
                    </div>
                    ${role === 'ai' ? `<div class="mt-2 text-[10px] text-white/20 uppercase font-bold tracking-wider">${modelUsed ? 'WikiMind ' + modelUsed : 'System'}</div>` : ''}
                </div>
            `;

            elements.chatContainer.appendChild(div);
            
            // Highlight code blocks
            div.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });

            scrollToBottom();
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-4 max-w-3xl mx-auto animate-fade-in";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center shrink-0 mt-1">
                    <i class="fa-solid fa-circle-notch fa-spin text-white/50 text-xs"></i>
                </div>
                <div class="glass-panel p-4 rounded-2xl rounded-tl-none border border-white/10 flex items-center gap-1">
                    <div class="w-2 h-2 bg-white/50 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-white/50 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-white/50 rounded-full typing-dot"></div>
                </div>
            `;
            elements.chatContainer.appendChild(div);
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // --------------------------------------------------------
        // 7. FIREBASE PERSISTENCE
        // --------------------------------------------------------
        function saveToFirebase(role, text, model = 'core') {
            if (!currentUser) return;
            const chatRef = ref(db, `users/${currentUser.uid}/chats`);
            push(chatRef, {
                role: role,
                text: text,
                model: model,
                timestamp: serverTimestamp()
            });
        }

        function loadChatHistory() {
            if (!currentUser) return;
            // Charger les derniers messages (limité à 50 pour la performance)
            // Note: Pour une vraie app, utiliser limitToLast(50) dans la query
            const chatRef = ref(db, `users/${currentUser.uid}/chats`);
            
            onChildAdded(chatRef, (snapshot) => {
                const data = snapshot.val();
                appendMessage(data.role, data.text, data.model);
            });
        }

        // --------------------------------------------------------
        // 8. AURORA ANIMATION BACKGROUND
        // --------------------------------------------------------
        const canvas = document.getElementById('aurora-bg');
        const ctx = canvas.getContext('2d');
        let width, height;
        
        const orbs = [
            { x: 0.2, y: 0.2, r: 0.4, color: 'rgba(99, 102, 241, 0.1)', vx: 0.0003, vy: 0.0003 }, // Indigo
            { x: 0.8, y: 0.3, r: 0.5, color: 'rgba(168, 85, 247, 0.1)', vx: -0.0004, vy: 0.0002 }, // Purple
            { x: 0.5, y: 0.8, r: 0.6, color: 'rgba(5, 5, 5, 0.8)', vx: 0, vy: 0 } // Black hole mask
        ];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, width, height);

            orbs.forEach(orb => {
                orb.x += orb.vx;
                orb.y += orb.vy;
                
                // Bounce simple
                if(orb.x < -0.2 || orb.x > 1.2) orb.vx *= -1;
                if(orb.y < -0.2 || orb.y > 1.2) orb.vy *= -1;

                const g = ctx.createRadialGradient(
                    orb.x * width, orb.y * height, 0,
                    orb.x * width, orb.y * height, orb.r * width
                );
                g.addColorStop(0, orb.color);
                g.addColorStop(1, 'rgba(0,0,0,0)');
                
                ctx.fillStyle = g;
                ctx.fillRect(0, 0, width, height);
            });
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);
        resize();
        animate();

    </script>
</body>
</html>