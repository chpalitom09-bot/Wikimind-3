<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WikiMind Ultimate</title>

    <!-- MANIFEST PWA (Base64) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiV2lraU1pbmQgVWx0aW1hdGUiLCJzaG9ydF9uYW1lIjoiV2lraUNhcmRzIiwic3RhcnRfdXJsIjoiIiwidGhlbWVfY29sb3IiOiIjMDAwMDAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvNDQzOC80NDM4MDE0LnBuZyIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

    <!-- LIBRAIRIES EXTERNES (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Code Barres 1D -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- QR Code 2D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: { brand: { 500: '#6366f1', 600: '#4f46e5' }, dark: '#050505' },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000; color: #fff; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-strong { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="file"] { display: none; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
    </style>
</head>
<body class="min-h-screen pb-32">

    <!-- BACKGROUND ANIM√â -->
    <div class="fixed inset-0 z-[-1] opacity-60 pointer-events-none">
        <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_50%_0%,#1e1b4b,transparent_70%)]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-brand-500/20 rounded-full blur-[100px] animate-float"></div>
    </div>

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-40 px-6 pt-6 pb-4 bg-gradient-to-b from-black via-black/90 to-transparent">
        <div class="flex justify-between items-center mb-4">
            <h1 class="font-display font-bold text-2xl tracking-tight flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-purple-600 flex items-center justify-center text-xs">üß†</span>
                WikiMind
            </h1>
            <div class="flex items-center gap-2 text-[10px] font-mono text-green-400 bg-green-500/10 px-2 py-1 rounded border border-green-500/20">
                <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                READY
            </div>
        </div>
        
        <!-- SEARCH -->
        <div class="glass h-12 rounded-xl flex items-center px-4 gap-3 focus-within:bg-white/10 transition-colors">
            <svg class="w-5 h-5 text-white/40" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <input type="text" id="search" placeholder="Rechercher (Action, McDo, Fnac...)" class="bg-transparent w-full h-full outline-none text-white placeholder-white/30 font-medium">
        </div>
    </header>

    <!-- GRID -->
    <main class="pt-36 px-4 max-w-xl mx-auto min-h-[70vh]">
        <!-- Logos rapides en haut de grille -->
        <div class="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2" id="top-brands-scroller">
            <!-- Inject√© via JS -->
        </div>

        <div id="grid" class="grid grid-cols-2 gap-4 pb-20">
            <!-- Cards ici -->
        </div>

        <div id="empty" class="hidden flex flex-col items-center justify-center pt-20 opacity-50">
            <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center text-3xl mb-4">üìÇ</div>
            <p class="font-display font-bold">Portefeuille vide</p>
        </div>
    </main>

    <!-- FAB -->
    <button onclick="openModal()" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-16 h-16 bg-white text-black rounded-full shadow-[0_0_50px_rgba(255,255,255,0.4)] flex items-center justify-center z-40 active:scale-95 transition-transform hover:rotate-90 duration-300">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
    </button>

    <!-- MODAL CREATEUR -->
    <div id="modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex flex-col justify-end sm:justify-center">
        <div class="absolute inset-0" onclick="closeModal()"></div>
        <div class="relative glass-strong w-full max-w-md mx-auto rounded-t-3xl sm:rounded-3xl p-6 transition-transform duration-300 transform translate-y-0 max-h-[95vh] overflow-y-auto">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-display font-bold text-xl">Ajouter une carte</h2>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">‚úï</button>
            </div>

            <div class="space-y-6">
                
                <!-- 1. IDENTIT√â -->
                <div>
                    <label class="text-[10px] uppercase font-bold text-brand-500 tracking-widest mb-2 block">Enseigne</label>
                    <div class="relative">
                        <input type="text" id="input-store" oninput="detectLogo()" class="w-full glass rounded-xl p-4 pl-14 text-white font-bold text-lg outline-none focus:border-brand-500" placeholder="Ex: Action">
                        <div id="store-icon" class="absolute left-2 top-2 bottom-2 w-10 bg-white/10 rounded-lg flex items-center justify-center overflow-hidden">üè™</div>
                    </div>
                </div>

                <!-- 2. TYPE DE VISUEL -->
                <div>
                    <label class="text-[10px] uppercase font-bold text-white/50 tracking-widest mb-2 block">Visuel de la carte</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="setVisualMode('logo')" id="btn-vis-logo" class="p-4 rounded-xl border border-brand-500 bg-brand-500/10 cursor-pointer text-center">
                            <span class="text-xl">‚ú®</span>
                            <div class="text-xs font-bold mt-1">Logo Officiel</div>
                        </div>
                        <div onclick="setVisualMode('photo')" id="btn-vis-photo" class="p-4 rounded-xl border border-white/10 bg-white/5 cursor-pointer text-center hover:bg-white/10">
                            <span class="text-xl">üì∑</span>
                            <div class="text-xs font-bold mt-1">Photo / Scan</div>
                        </div>
                    </div>

                    <!-- PREVIEW PHOTO ZONE -->
                    <div id="photo-upload-zone" class="hidden mt-3">
                        <div onclick="document.getElementById('file-input').click()" class="w-full h-32 border-2 border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-white/50 overflow-hidden relative">
                            <img id="img-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                            <span class="text-2xl">‚ûï</span>
                            <span class="text-xs mt-2 text-white/50">Importer l'image</span>
                        </div>
                        <input type="file" id="file-input" accept="image/*" onchange="handleImage(this)">
                    </div>
                </div>

                <!-- 3. TYPE DE CODE (BARRE ou QR) -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-[10px] uppercase font-bold text-white/50 tracking-widest">Type de code</label>
                        <div class="flex bg-white/10 rounded-lg p-1">
                            <button onclick="setCodeType('bar')" id="btn-type-bar" class="px-3 py-1 rounded text-xs font-bold bg-white text-black transition-all">Barre |||</button>
                            <button onclick="setCodeType('qr')" id="btn-type-qr" class="px-3 py-1 rounded text-xs font-bold text-white/50 hover:text-white transition-all">QR ‚ñ£</button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="text" id="input-code" oninput="updatePreview()" class="w-full glass rounded-xl p-4 font-mono text-lg outline-none focus:border-brand-500" placeholder="Num√©ro du code...">
                        <button onclick="generateRandom()" class="px-4 glass rounded-xl text-xl">üé≤</button>
                    </div>

                    <!-- LIVE PREVIEW CODE -->
                    <div class="mt-3 bg-white rounded-xl p-4 flex items-center justify-center h-24 overflow-hidden relative">
                        <svg id="preview-barcode" class="w-full h-full"></svg>
                        <div id="preview-qrcode" class="hidden"></div>
                        <div id="preview-placeholder" class="absolute text-black/20 text-xs font-bold">APER√áU</div>
                    </div>
                </div>

                <button onclick="saveCard()" id="btn-save" class="w-full py-4 rounded-xl bg-white text-black font-bold uppercase tracking-widest hover:scale-[1.02] transition-transform shadow-xl">
                    Ajouter au portefeuille
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL VIEWER (FULLSCREEN) -->
    <div id="viewer" class="fixed inset-0 z-[60] bg-black hidden flex flex-col items-center justify-center p-4">
        <button onclick="closeViewer()" class="absolute top-6 right-6 w-12 h-12 bg-white/10 rounded-full text-white z-20 flex items-center justify-center backdrop-blur text-xl">‚úï</button>
        
        <div class="w-full max-w-sm flex flex-col gap-6 items-center relative z-10 animate-[fadeIn_0.3s_ease-out]">
            <h2 id="view-title" class="text-4xl font-display font-bold text-center text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500">Titre</h2>
            
            <!-- VISUEL CARTE -->
            <div class="w-full aspect-[1.586/1] rounded-2xl overflow-hidden shadow-[0_0_60px_rgba(255,255,255,0.1)] border border-white/20 bg-white relative group">
                <img id="view-img" class="w-full h-full object-cover hidden">
                <div id="view-logo" class="w-full h-full flex items-center justify-center p-8 hidden"></div>
            </div>

            <!-- ZONE CODE (Blanc √©clatant pour scan) -->
            <div class="w-full bg-white p-6 rounded-3xl shadow-2xl transform hover:scale-105 transition-transform duration-300">
                <div class="flex justify-center items-center min-h-[100px]">
                    <svg id="view-barcode" class="w-full h-24"></svg>
                    <div id="view-qrcode"></div>
                </div>
            </div>
            
            <p id="view-code-text" class="font-mono text-xl tracking-[0.2em] text-white/60"></p>

            <button onclick="deleteCard()" class="mt-4 text-red-500 text-xs uppercase font-bold tracking-widest px-6 py-3 rounded-xl border border-red-500/20 hover:bg-red-500/10 transition">
                Supprimer
            </button>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- 1. BASE DE DONN√âES LOGOS (40+ SVG OPTIMIS√âS) ---
        // Format: Cl√© (minuscule) -> SVG String
        const LOGOS = {
            'fnac': '<svg viewBox="0 0 100 100" fill="#EAB308"><rect width="100" height="100"/><path fill="black" d="M20 30h15v40h-15z M45 30h15v15h10v-15h15v40h-15v-15h-10v15h-15z"/></svg>',
            'carrefour': '<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="white"/><path d="M50 10 L90 50 L50 90 L10 50 Z" fill="#003399"/><circle cx="50" cy="50" r="35" fill="white"/><path d="M45 35h10v30h-10z" fill="#EF4444"/><path d="M30 50l15-15v30z" fill="#003399"/></svg>',
            'leclerc': '<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="#0066CC"/><text x="50" y="70" text-anchor="middle" fill="white" font-weight="bold" font-size="60" font-family="Arial">L</text><circle cx="50" cy="50" r="40" stroke="orange" stroke-width="5" fill="none"/></svg>',
            'decathlon': '<svg viewBox="0 0 100 100" fill="#0082C3"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="16" font-family="Arial">DECATHLON</text></svg>',
            'ikea': '<svg viewBox="0 0 100 100" fill="#0051BA"><rect width="100" height="100"/><ellipse cx="50" cy="50" rx="45" ry="30" fill="#FFDA1A"/><text x="50" y="60" text-anchor="middle" fill="#0051BA" font-weight="bold" font-size="30">IKEA</text></svg>',
            'action': '<svg viewBox="0 0 100 100" fill="#009EE3"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="25">ACTION</text></svg>',
            'lidl': '<svg viewBox="0 0 100 100" fill="#0050AA"><rect width="100" height="100"/><rect x="10" y="10" width="80" height="80" fill="#FFF000"/><circle cx="50" cy="50" r="35" fill="#E60000"/><text x="50" y="60" text-anchor="middle" fill="#0050AA" font-weight="bold" font-size="30" font-style="italic">LiDL</text></svg>',
            'sephora': '<svg viewBox="0 0 100 100" fill="black"><rect width="100" height="100"/><path d="M10 50 Q50 10 90 50" stroke="white" stroke-width="2" fill="none"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="16" letter-spacing="2">SEPHORA</text></svg>',
            'auchan': '<svg viewBox="0 0 100 100" fill="white"><rect width="100" height="100"/><path d="M50 20 L30 80 h40 Z" fill="#E2001A"/><path d="M50 25 L40 60 h20 Z" fill="#008C44"/></svg>',
            'intermarch√©': '<svg viewBox="0 0 100 100" fill="white"><rect width="100" height="100"/><path d="M20 20 h60 v60 h-60 z" fill="#E2001A"/><rect x="30" y="45" width="40" height="10" fill="white"/><path d="M50 20 l10 20 h-20 z" fill="white"/></svg>',
            'u': '<svg viewBox="0 0 100 100" fill="#00AEEF"><rect width="100" height="100"/><text x="50" y="75" text-anchor="middle" fill="white" font-weight="bold" font-size="80">U</text></svg>',
            'monoprix': '<svg viewBox="0 0 100 100" fill="white"><rect width="100" height="100"/><text x="50" y="50" text-anchor="middle" fill="black" font-weight="bold" font-size="20">MONOPRIX</text><path d="M20 60 h60 v10 h-60 z" fill="#E2001A"/></svg>',
            'leroy': '<svg viewBox="0 0 100 100" fill="#78BE20"><path d="M20 20 L80 20 L50 80 Z"/><text x="50" y="40" text-anchor="middle" fill="white" font-size="10">LEROY MERLIN</text></svg>',
            'castorama': '<svg viewBox="0 0 100 100" fill="#FFD100"><rect width="100" height="100"/><path d="M20 50 h60" stroke="#005596" stroke-width="10"/></svg>',
            'darty': '<svg viewBox="0 0 100 100" fill="#E60000"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="20">DARTY</text><circle cx="50" cy="50" r="40" stroke="white" stroke-width="2" fill="none"/></svg>',
            'boulanger': '<svg viewBox="0 0 100 100" fill="#FF5E00"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="30">B</text></svg>',
            'apple': '<svg viewBox="0 0 100 100" fill="black"><rect width="100" height="100"/><circle cx="50" cy="55" r="25" fill="white"/><circle cx="65" cy="30" r="8" fill="white"/></svg>',
            'micromania': '<svg viewBox="0 0 100 100" fill="#004481"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="12">MICROMANIA</text></svg>',
            'zara': '<svg viewBox="0 0 100 100" fill="black"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-family="serif" font-size="25">ZARA</text></svg>',
            'h&m': '<svg viewBox="0 0 100 100" fill="#E50010"><rect width="100" height="100"/><text x="50" y="65" text-anchor="middle" fill="white" font-family="serif" font-weight="bold" font-size="35">H&M</text></svg>',
            'kiabi': '<svg viewBox="0 0 100 100" fill="#0090D6"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="25">KIABI</text></svg>',
            'intersport': '<svg viewBox="0 0 100 100" fill="#006CB7"><rect width="100" height="100"/><rect x="20" y="40" width="20" height="20" fill="white"/><rect x="50" y="40" width="30" height="20" fill="#E2001A"/></svg>',
            'nike': '<svg viewBox="0 0 100 100" fill="black"><rect width="100" height="100"/><path d="M20 60 Q40 80 80 40 L75 35 Q40 60 20 60 Z" fill="white"/></svg>',
            'adidas': '<svg viewBox="0 0 100 100" fill="black"><rect width="100" height="100"/><path d="M30 70 L40 50 L50 70 M50 70 L60 30 L70 70" stroke="white" stroke-width="8"/></svg>',
            'mcdo': '<svg viewBox="0 0 100 100" fill="#DA291C"><rect width="100" height="100"/><path d="M25 70 Q25 30 50 50 Q75 30 75 70" stroke="#FFC72C" stroke-width="8" fill="none"/></svg>',
            'burger king': '<svg viewBox="0 0 100 100" fill="#F2A900"><rect width="100" height="100"/><text x="50" y="55" text-anchor="middle" fill="#DA291C" font-weight="bold" font-size="20">BURGER</text><text x="50" y="75" text-anchor="middle" fill="#DA291C" font-weight="bold" font-size="20">KING</text></svg>',
            'kfc': '<svg viewBox="0 0 100 100" fill="#A3080C"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="40">KFC</text></svg>',
            'subway': '<svg viewBox="0 0 100 100" fill="#008C15"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="#FFC20E" font-weight="bold" font-size="25">SUBWAY</text></svg>',
            'starbucks': '<svg viewBox="0 0 100 100" fill="#00704A"><rect width="100" height="100"/><circle cx="50" cy="50" r="30" fill="white"/><circle cx="50" cy="50" r="25" fill="#00704A"/></svg>',
            'total': '<svg viewBox="0 0 100 100" fill="#ED0000"><rect width="100" height="100" fill="white"/><circle cx="50" cy="50" r="40" stroke="#ED0000" stroke-width="5" fill="none"/><path d="M50 10 L90 50 L50 90" fill="none" stroke="#004C99" stroke-width="5"/><path d="M50 10 L10 50 L50 90" fill="none" stroke="#F68D2E" stroke-width="5"/></svg>',
            'sncf': '<svg viewBox="0 0 100 100" fill="#820033"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-style="italic" font-weight="bold" font-size="30">SNCF</text></svg>',
            'gifi': '<svg viewBox="0 0 100 100" fill="#ED0000"><rect width="100" height="100"/><text x="50" y="65" text-anchor="middle" fill="white" font-weight="bold" font-size="40">Gifi</text></svg>',
            'but': '<svg viewBox="0 0 100 100" fill="#ED0000"><rect width="100" height="100"/><text x="50" y="65" text-anchor="middle" fill="white" font-weight="bold" font-size="40">BUT</text></svg>',
            'conforama': '<svg viewBox="0 0 100 100" fill="#000000"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="18">CONFORAMA</text></svg>',
            'picard': '<svg viewBox="0 0 100 100" fill="#009fe3"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="25">picard</text></svg>',
            'generic': '<svg viewBox="0 0 100 100" fill="#333"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="40">?</text></svg>'
        };

        // --- STATE GLOBAL ---
        let cards = JSON.parse(localStorage.getItem('wikimind_v4_cards')) || [];
        let currentState = {
            visualMode: 'logo', // 'logo' | 'photo'
            codeType: 'bar', // 'bar' | 'qr'
            imageBase64: null
        };
        let currentViewId = null;

        // --- INIT ---
        window.onload = () => {
            renderCards();
            renderTopBrands();
        };

        // --- RENDU UI PRINCIPAL ---
        function renderCards() {
            const grid = document.getElementById('grid');
            const empty = document.getElementById('empty');
            const searchVal = document.getElementById('search').value.toLowerCase();
            grid.innerHTML = '';

            const filtered = cards.filter(c => c.store.toLowerCase().includes(searchVal));

            if (filtered.length === 0 && !searchVal) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                filtered.forEach(card => {
                    const el = document.createElement('div');
                    el.className = 'relative aspect-[1.586/1] rounded-2xl overflow-hidden cursor-pointer shadow-lg border border-white/10 group bg-gray-900 hover:scale-[1.02] transition-transform';
                    el.onclick = () => openViewer(card.id);

                    let visual = '';
                    if(card.visualMode === 'logo') {
                        const svg = LOGOS[card.logoKey] || LOGOS['generic'];
                        visual = `<div class="w-full h-full bg-white flex items-center justify-center p-6">${svg}</div>`;
                    } else {
                        visual = `<img src="${card.image}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">`;
                    }

                    el.innerHTML = `
                        ${visual}
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent pointer-events-none"></div>
                        <div class="absolute bottom-3 left-4 right-4 pointer-events-none">
                            <h3 class="font-bold text-white text-lg leading-none truncate shadow-black drop-shadow-md">${card.store}</h3>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-[10px] text-white/70 font-mono truncate max-w-[70%]">${card.code}</p>
                                <span class="text-[10px] bg-white/20 px-1.5 rounded text-white/80">${card.codeType === 'qr' ? 'QR' : '|||'}</span>
                            </div>
                        </div>
                    `;
                    grid.appendChild(el);
                });
            }
        }

        document.getElementById('search').addEventListener('input', renderCards);

        function renderTopBrands() {
            const container = document.getElementById('top-brands-scroller');
            // S√©lection de quelques marques pour l'acc√®s rapide
            const top = ['fnac','leclerc','carrefour','decathlon','ikea','mcdo','action','sephora','apple'];
            
            top.forEach(key => {
                const div = document.createElement('div');
                div.className = "w-12 h-12 rounded-full bg-white p-1 flex-shrink-0 cursor-pointer border-2 border-transparent hover:border-brand-500 hover:scale-110 transition-all shadow-lg";
                div.innerHTML = LOGOS[key];
                div.onclick = () => {
                    openModal();
                    document.getElementById('input-store').value = key.charAt(0).toUpperCase() + key.slice(1);
                    detectLogo();
                }
                container.appendChild(div);
            });
        }

        // --- MODAL CREATOR ---
        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
            resetModal();
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function resetModal() {
            document.getElementById('input-store').value = '';
            document.getElementById('input-code').value = '';
            document.getElementById('img-preview').classList.add('hidden');
            currentState = { visualMode: 'logo', codeType: 'bar', imageBase64: null };
            setVisualMode('logo');
            setCodeType('bar');
            detectLogo();
        }

        // 1. D√©tection Logo
        function detectLogo() {
            const val = document.getElementById('input-store').value.toLowerCase();
            const icon = document.getElementById('store-icon');
            let foundKey = 'generic';
            
            for(let key in LOGOS) {
                if(val.includes(key) && key !== 'generic') {
                    foundKey = key;
                    break;
                }
            }
            icon.innerHTML = `<div class="w-full h-full p-1 bg-white rounded">${LOGOS[foundKey]}</div>`;
            return foundKey;
        }

        // 2. Gestion Visuel
        function setVisualMode(mode) {
            currentState.visualMode = mode;
            const btnLogo = document.getElementById('btn-vis-logo');
            const btnPhoto = document.getElementById('btn-vis-photo');
            const photoZone = document.getElementById('photo-upload-zone');

            if(mode === 'logo') {
                btnLogo.className = "p-4 rounded-xl border border-brand-500 bg-brand-500/10 cursor-pointer text-center transition-all";
                btnPhoto.className = "p-4 rounded-xl border border-white/10 bg-white/5 cursor-pointer text-center hover:bg-white/10 transition-all opacity-50";
                photoZone.classList.add('hidden');
            } else {
                btnPhoto.className = "p-4 rounded-xl border border-brand-500 bg-brand-500/10 cursor-pointer text-center transition-all";
                btnLogo.className = "p-4 rounded-xl border border-white/10 bg-white/5 cursor-pointer text-center hover:bg-white/10 transition-all opacity-50";
                photoZone.classList.remove('hidden');
            }
        }

        function handleImage(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        // Compression Canvas
                        const cvs = document.createElement('canvas');
                        const scale = 600 / Math.max(img.width, img.height);
                        cvs.width = img.width * scale;
                        cvs.height = img.height * scale;
                        const ctx = cvs.getContext('2d');
                        ctx.drawImage(img,0,0,cvs.width,cvs.height);
                        currentState.imageBase64 = cvs.toDataURL('image/jpeg', 0.7);
                        
                        document.getElementById('img-preview').src = currentState.imageBase64;
                        document.getElementById('img-preview').classList.remove('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 3. Gestion Code (Barre vs QR)
        function setCodeType(type) {
            currentState.codeType = type;
            const btnBar = document.getElementById('btn-type-bar');
            const btnQr = document.getElementById('btn-type-qr');
            
            if(type === 'bar') {
                btnBar.className = "px-3 py-1 rounded text-xs font-bold bg-white text-black shadow-lg";
                btnQr.className = "px-3 py-1 rounded text-xs font-bold text-white/50 hover:text-white";
            } else {
                btnQr.className = "px-3 py-1 rounded text-xs font-bold bg-white text-black shadow-lg";
                btnBar.className = "px-3 py-1 rounded text-xs font-bold text-white/50 hover:text-white";
            }
            updatePreview();
        }

        function updatePreview() {
            const val = document.getElementById('input-code').value || '1234';
            const barContainer = document.getElementById('preview-barcode');
            const qrContainer = document.getElementById('preview-qrcode');
            const placeholder = document.getElementById('preview-placeholder');
            
            placeholder.classList.add('hidden');

            if(currentState.codeType === 'bar') {
                barContainer.style.display = 'block';
                qrContainer.style.display = 'none';
                qrContainer.innerHTML = '';
                try {
                    JsBarcode("#preview-barcode", val, { format: "CODE128", displayValue: false, height: 50, margin: 0 });
                } catch(e){}
            } else {
                barContainer.style.display = 'none';
                qrContainer.style.display = 'block';
                qrContainer.innerHTML = '';
                try {
                    new QRCode(qrContainer, { text: val, width: 80, height: 80, colorDark: "#000000", colorLight: "#ffffff" });
                } catch(e){}
            }
        }

        function generateRandom() {
            document.getElementById('input-code').value = Math.floor(Math.random() * 1000000000000);
            updatePreview();
        }

        // 4. Sauvegarde
        function saveCard() {
            const store = document.getElementById('input-store').value.trim();
            const code = document.getElementById('input-code').value.trim();
            
            if(!store) return alert("Nom manquant");
            if(currentState.visualMode === 'photo' && !currentState.imageBase64) return alert("Photo manquante");
            if(!code) return alert("Code manquant");

            const card = {
                id: Date.now(),
                store,
                code,
                codeType: currentState.codeType,
                visualMode: currentState.visualMode,
                logoKey: detectLogo(),
                image: currentState.imageBase64
            };

            try {
                cards.unshift(card);
                localStorage.setItem('wikimind_v4_cards', JSON.stringify(cards));
                closeModal();
                renderCards();
            } catch(e) {
                alert("M√©moire pleine. Supprimez des cartes.");
            }
        }

        // --- VIEWER (FULLSCREEN) ---
        function openViewer(id) {
            const card = cards.find(c => c.id === id);
            currentViewId = id;

            document.getElementById('view-title').innerText = card.store;
            document.getElementById('view-code-text').innerText = card.code;
            document.getElementById('viewer').classList.remove('hidden');

            // Visuel
            const imgEl = document.getElementById('view-img');
            const logoEl = document.getElementById('view-logo');
            if(card.visualMode === 'logo') {
                imgEl.classList.add('hidden');
                logoEl.classList.remove('hidden');
                logoEl.innerHTML = LOGOS[card.logoKey] || LOGOS['generic'];
            } else {
                logoEl.classList.add('hidden');
                imgEl.classList.remove('hidden');
                imgEl.src = card.image;
            }

            // Code
            const barEl = document.getElementById('view-barcode');
            const qrEl = document.getElementById('view-qrcode');
            qrEl.innerHTML = '';

            if(card.codeType === 'bar') {
                barEl.style.display = 'block';
                qrEl.style.display = 'none';
                try {
                    JsBarcode("#view-barcode", card.code, { format: "CODE128", displayValue: false, height: 100, width: 3, margin: 10 });
                } catch(e){}
            } else {
                barEl.style.display = 'none';
                qrEl.style.display = 'flex';
                qrEl.style.justifyContent = 'center';
                try {
                    new QRCode(qrEl, { text: card.code, width: 150, height: 150 });
                } catch(e){}
            }
        }

        function closeViewer() { document.getElementById('viewer').classList.add('hidden'); }

        function deleteCard() {
            if(confirm("Supprimer ?")) {
                cards = cards.filter(c => c.id !== currentViewId);
                localStorage.setItem('wikimind_v4_cards', JSON.stringify(cards));
                renderCards();
                closeViewer();
            }
        }
    </script>
</body>
</html>
