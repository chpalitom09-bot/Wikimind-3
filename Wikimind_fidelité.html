<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>WikiMind Vision</title>
    
    <!-- PWA Manifest Inline -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiV2lraU1pbmQgVmlzaW9uIiwic2hvcnRfbmFtZSI6Ildpa2lWaXMiLCJzdGFydF91cmwiOiIiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDAwMDAwIiwidGhlbWVfY29sb3IiOiIjMDAwMDAwIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzQ0MzgvNDQzODAxNC5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">

    <!-- Tailwind & Logiciels -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: { glass: 'rgba(20, 20, 20, 0.8)', brand: '#6366f1' },
                    animation: { 'scan': 'scan 2s linear infinite' },
                    keyframes: { scan: { '0%': { top: '0%' }, '100%': { top: '100%' } } }
                }
            }
        }
    </script>

    <style>
        body { background: #000; color: #fff; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass-panel { background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* Loader IA */
        .ai-glow { box-shadow: 0 0 30px rgba(99, 102, 241, 0.5); }
    </style>
</head>
<body class="min-h-screen pb-32 selection:bg-brand selection:text-white">

    <!-- AURORA BG -->
    <canvas id="aurora-canvas" class="fixed inset-0 z-[-1] opacity-60"></canvas>

    <!-- HEADER / SEARCH -->
    <header class="fixed top-0 w-full z-40 px-4 pt-4 pb-2 bg-gradient-to-b from-black via-black/80 to-transparent">
        <div class="glass-panel rounded-full h-14 flex items-center px-4 gap-3 shadow-2xl">
            <div class="w-8 h-8 rounded-full bg-brand flex items-center justify-center font-bold text-lg text-white">W</div>
            <input type="text" id="search-input" placeholder="Rechercher une carte..." class="bg-transparent w-full h-full focus:outline-none text-white placeholder-white/40 font-medium">
            <svg class="w-5 h-5 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>
    </header>

    <!-- GRID CARTES -->
    <main class="pt-24 px-4 container mx-auto max-w-lg min-h-[80vh]">
        <div id="cards-container" class="grid grid-cols-2 gap-3">
            <!-- InjectÃ© par JS -->
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="hidden flex flex-col items-center justify-center pt-32 text-center opacity-60">
            <div class="w-20 h-20 rounded-2xl border-2 border-dashed border-white/20 flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
            <p class="font-display font-bold text-lg">Aucune carte</p>
            <p class="text-xs text-white/50 mt-1">Vos cartes seront sauvegardÃ©es<br>localement sur cet appareil.</p>
        </div>
    </main>

    <!-- ADD BUTTON -->
    <button onclick="document.getElementById('file-input').click()" class="fixed bottom-8 right-1/2 translate-x-1/2 w-16 h-16 bg-white text-black rounded-full shadow-[0_0_40px_rgba(255,255,255,0.3)] flex items-center justify-center z-40 active:scale-90 transition-transform hover:rotate-90 duration-300">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
    </button>
    <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(this)">

    <!-- AI ANALYZING OVERLAY -->
    <div id="ai-overlay" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-md hidden flex flex-col items-center justify-center p-6">
        <div class="relative w-64 h-40 rounded-xl overflow-hidden border border-brand/50 ai-glow mb-8">
            <img id="preview-analysis" class="w-full h-full object-cover opacity-50">
            <div class="absolute inset-0 bg-brand/10 w-full h-1 animate-scan shadow-[0_0_20px_#6366f1]"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-xs font-mono bg-black/50 px-2 py-1 rounded text-brand animate-pulse">ANALYSE MISTRAL AI...</span>
            </div>
        </div>
        <p class="text-white/50 text-center text-sm max-w-xs animate-pulse">DÃ©tection du magasin et extraction des donnÃ©es...</p>
    </div>

    <!-- EDIT/SAVE MODAL -->
    <div id="edit-modal" class="fixed inset-0 z-50 bg-black flex flex-col hidden transform transition-transform duration-300 translate-y-full">
        <div class="flex justify-between items-center p-6">
            <button onclick="closeEditModal()" class="text-white/50 hover:text-white">Annuler</button>
            <h3 class="font-display font-bold text-lg">Nouvelle Carte</h3>
            <button onclick="saveCard()" class="text-brand font-bold">Sauver</button>
        </div>
        
        <div class="px-6 flex flex-col gap-6 overflow-y-auto pb-10">
            <!-- Image Preview -->
            <div class="w-full h-48 rounded-2xl overflow-hidden relative shadow-lg">
                <img id="final-preview" class="w-full h-full object-cover">
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs uppercase font-bold text-white/40 tracking-widest">Nom du magasin</label>
                    <input type="text" id="store-name" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 mt-2 text-xl font-display font-bold text-white focus:border-brand focus:outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs uppercase font-bold text-white/40 tracking-widest">Code-barres / NumÃ©ro</label>
                    <div class="flex gap-2 mt-2">
                         <input type="text" id="card-number" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 font-mono text-white focus:border-brand focus:outline-none transition-colors">
                         <button onclick="generateRandomBarcode()" class="px-4 bg-white/5 rounded-xl border border-white/10 hover:bg-white/10">ðŸŽ²</button>
                    </div>
                    <p class="text-[10px] text-white/30 mt-2">*L'IA tente de lire le code, sinon copiez les chiffres sous le code-barres.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FULLSCREEN CARD VIEW -->
    <div id="view-modal" class="fixed inset-0 z-50 bg-black hidden flex flex-col">
        <div class="relative flex-1">
            <!-- Image bg blurred -->
            <div class="absolute inset-0 overflow-hidden">
                <img id="view-bg" class="w-full h-full object-cover blur-3xl opacity-30 scale-110">
            </div>
            
            <!-- Content -->
            <div class="relative z-10 h-full flex flex-col p-6">
                <div class="flex justify-between items-center mb-8">
                    <button onclick="closeViewModal()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-md text-white">âœ•</button>
                    <button onclick="deleteCard()" class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center backdrop-blur-md text-red-500">ðŸ—‘</button>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center gap-8">
                    <h2 id="view-title" class="text-4xl font-display font-bold text-center drop-shadow-xl">Store</h2>
                    
                    <!-- Real Card Image -->
                    <div class="w-full max-w-sm aspect-[1.586/1] rounded-2xl overflow-hidden shadow-2xl border border-white/20 transform hover:scale-105 transition-transform duration-500">
                        <img id="view-img" class="w-full h-full object-cover">
                    </div>

                    <!-- Generated Barcode -->
                    <div class="w-full max-w-sm bg-white p-4 rounded-2xl shadow-[0_0_50px_rgba(255,255,255,0.1)]">
                        <svg id="view-barcode" class="w-full h-24"></svg>
                    </div>
                    <p id="view-number" class="font-mono text-lg tracking-widest text-white/60"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION MISTRAL API
        const MISTRAL_API_KEY = "2Dc4NHEdCUbHNTacaXNFzm8AwP6UEote"; // ClÃ© fournie
        
        // ETAT GLOBAL
        let cards = JSON.parse(localStorage.getItem('wikimind_cards_v2')) || [];
        let tempImageBase64 = null;
        let currentViewIndex = null;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderCards();
            initAurora();
            
            // Recherche instantanÃ©e
            document.getElementById('search-input').addEventListener('input', (e) => {
                renderCards(e.target.value);
            });
        });

        // --- GESTION IMAGE & IA ---
        
        async function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // 1. Compression de l'image (Crucial pour localStorage)
                const compressedBase64 = await compressImage(file);
                tempImageBase64 = compressedBase64;

                // 2. Interface IA
                const overlay = document.getElementById('ai-overlay');
                document.getElementById('preview-analysis').src = compressedBase64;
                overlay.classList.remove('hidden');

                // 3. Appel Mistral AI
                if (navigator.onLine) {
                    try {
                        const analysis = await analyzeImageWithMistral(compressedBase64);
                        openEditModal(analysis.store, analysis.number);
                    } catch (error) {
                        console.error("Erreur IA:", error);
                        alert("Mode hors ligne ou erreur IA. Passage en mode manuel.");
                        openEditModal("", "");
                    }
                } else {
                    // Mode Avion
                    setTimeout(() => openEditModal("", ""), 1000);
                }
                
                overlay.classList.add('hidden');
                input.value = ''; // Reset
            }
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Max dimension 800px pour garder une bonne qualitÃ© mais petite taille
                        const scale = 800 / Math.max(img.width, img.height);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Output en JPEG 60%
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        }

        async function analyzeImageWithMistral(base64Image) {
            // Nettoyage du header base64 pour l'envoi
            const base64Data = base64Image.split(',')[1];

            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${MISTRAL_API_KEY}`
                },
                body: JSON.stringify({
                    model: "pixtral-12b-2409", // ModÃ¨le Vision
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "Analyse cette carte de fidÃ©litÃ©. RÃ©ponds UNIQUEMENT avec un objet JSON strict sans markdown : {\"store\": \"Nom du magasin\", \"number\": \"NumÃ©ro de carte visible (sinon vide)\"}. Si tu ne trouves pas le nom, devine par le logo." },
                                { type: "image_url", imageUrl: `data:image/jpeg;base64,${base64Data}` }
                            ]
                        }
                    ],
                    response_format: { type: "json_object" }
                })
            });

            const data = await response.json();
            if(data.choices && data.choices[0].message.content) {
                return JSON.parse(data.choices[0].message.content);
            }
            throw new Error("RÃ©ponse vide");
        }

        // --- MODALES & CRUD ---

        function openEditModal(storeName, number) {
            const modal = document.getElementById('edit-modal');
            document.getElementById('final-preview').src = tempImageBase64;
            document.getElementById('store-name').value = storeName || "";
            document.getElementById('card-number').value = number || "";
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('translate-y-full'), 10);
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function generateRandomBarcode() {
            // GÃ©nÃ¨re un EAN-13 random si l'IA Ã©choue
            let result = '';
            for (let i = 0; i < 12; i++) result += Math.floor(Math.random() * 10);
            document.getElementById('card-number').value = result;
        }

        function saveCard() {
            const store = document.getElementById('store-name').value;
            const number = document.getElementById('card-number').value || "000000000";
            
            if(!store) return alert("Nom requis");

            cards.unshift({
                id: Date.now(),
                store: store,
                number: number,
                image: tempImageBase64 // L'image est stockÃ©e en base64
            });

            // Sauvegarde LocalStorage
            try {
                localStorage.setItem('wikimind_cards_v2', JSON.stringify(cards));
                renderCards();
                closeEditModal();
            } catch (e) {
                alert("MÃ©moire pleine ! Supprimez quelques cartes.");
            }
        }

        function renderCards(filter = "") {
            const container = document.getElementById('cards-container');
            const empty = document.getElementById('empty-state');
            
            container.innerHTML = '';
            
            const filteredCards = cards.filter(c => c.store.toLowerCase().includes(filter.toLowerCase()));

            if (filteredCards.length === 0) {
                if(!filter) empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                
                filteredCards.forEach((card, index) => {
                    const el = document.createElement('div');
                    // Carte avec image rÃ©elle
                    el.className = 'relative aspect-[1.586/1] rounded-2xl overflow-hidden cursor-pointer group shadow-lg border border-white/5 animate-[fadeIn_0.5s_ease-out]';
                    el.onclick = () => openViewModal(card.id);
                    el.innerHTML = `
                        <img src="${card.image}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                        <div class="absolute bottom-3 left-3 right-3">
                            <h3 class="font-display font-bold text-white text-lg leading-tight truncate">${card.store}</h3>
                            <p class="font-mono text-[10px] text-white/60 truncate tracking-wider">${card.number}</p>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }
        }

        // --- FULLSCREEN VIEW ---

        function openViewModal(id) {
            const card = cards.find(c => c.id === id);
            if(!card) return;
            currentViewIndex = cards.indexOf(card);

            document.getElementById('view-title').innerText = card.store;
            document.getElementById('view-img').src = card.image;
            document.getElementById('view-bg').src = card.image;
            document.getElementById('view-number').innerText = card.number;

            // GÃ©nÃ©ration Code-barres
            try {
                JsBarcode("#view-barcode", card.number, {
                    format: "CODE128",
                    displayValue: false,
                    height: 80,
                    margin: 0,
                    width: 2
                });
            } catch(e) { console.log(e); }

            document.getElementById('view-modal').classList.remove('hidden');
        }

        function closeViewModal() {
            document.getElementById('view-modal').classList.add('hidden');
        }

        function deleteCard() {
            if(confirm("Supprimer cette carte ?")) {
                cards.splice(currentViewIndex, 1);
                localStorage.setItem('wikimind_cards_v2', JSON.stringify(cards));
                renderCards();
                closeViewModal();
            }
        }

        // --- BACKGROUND AURORA ---
        function initAurora() {
            const c = document.getElementById('aurora-canvas');
            const ctx = c.getContext('2d');
            let w, h;
            const orbs = [
                {x:0.2,y:0.2,r:0.4,c:'#6366f1',vx:0.0002,vy:0.0003},
                {x:0.8,y:0.8,r:0.5,c:'#a855f7',vx:-0.0003,vy:-0.0002}
            ];
            
            function resize(){ w=c.width=window.innerWidth; h=c.height=window.innerHeight; }
            function animate(){
                ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
                orbs.forEach(o=>{
                    o.x+=o.vx; o.y+=o.vy;
                    if(o.x<0||o.x>1) o.vx*=-1; if(o.y<0||o.y>1) o.vy*=-1;
                    const g=ctx.createRadialGradient(o.x*w,o.y*h,0,o.x*w,o.y*h,o.r*w);
                    g.addColorStop(0,o.c+'30'); g.addColorStop(1,'transparent');
                    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(o.x*w,o.y*h,o.r*w,0,Math.PI*2); ctx.fill();
                });
                requestAnimationFrame(animate);
            }
            window.addEventListener('resize',resize); resize(); animate();
        }
    </script>
</body>
</html>
