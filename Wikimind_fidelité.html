<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WikiMind Ultimate</title>

    <!-- PWA MANIFEST & ICON (GÃ©nÃ©rÃ© en Base64 pour fichier unique) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiV2lraU1pbmQgVWx0aW1hdGUiLCJzaG9ydF9uYW1lIjoiV2lraUNhcmRzIiwic3RhcnRfdXJsIjoiIiwidGhlbWVfY29sb3IiOiIjMDAwMDAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly91cGxvYWQud2lraW1lZGlhLm9yZy93aWtpcGVkaWEvY29tbW9ucy9hL2E3L1JlYWN0LWljb24uc3ZnIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: { brand: { 500: '#6366f1', 600: '#4f46e5' }, dark: '#050505' },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000; color: #fff; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Crop Tool Styles */
        #crop-container { touch-action: none; }
        .crop-overlay { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8); }
    </style>
</head>
<body class="min-h-screen pb-32">

    <!-- AURORA BACKGROUND -->
    <div class="fixed inset-0 z-[-1]">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-600/20 rounded-full blur-[100px] animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-purple-600/20 rounded-full blur-[100px] animate-float" style="animation-delay: -3s;"></div>
    </div>

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-40 px-6 pt-6 pb-4 bg-gradient-to-b from-black via-black/90 to-transparent">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-500 to-purple-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                    <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                </div>
                <h1 class="font-display font-bold text-2xl tracking-tight">WikiMind</h1>
            </div>
            <div class="text-xs font-mono text-white/40 bg-white/5 px-3 py-1 rounded-full border border-white/5">OFFLINE READY</div>
        </div>
        
        <!-- Search Bar -->
        <div class="glass h-12 rounded-xl flex items-center px-4 gap-3 transition-all focus-within:border-brand-500/50 focus-within:bg-white/10">
            <svg class="w-5 h-5 text-white/40" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <input type="text" id="search" placeholder="Rechercher (Fnac, Leclerc...)" class="bg-transparent w-full h-full outline-none text-white placeholder-white/30 font-medium">
        </div>
    </header>

    <!-- CARD GRID -->
    <main class="pt-36 px-4 max-w-lg mx-auto min-h-[70vh]">
        <div id="grid" class="grid grid-cols-2 gap-4 pb-20">
            <!-- Cards Injected Here -->
        </div>

        <!-- Empty State -->
        <div id="empty" class="hidden flex flex-col items-center justify-center pt-20 opacity-50">
            <div class="w-24 h-24 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mb-4">
                <svg class="w-10 h-10 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
            </div>
            <p class="font-display font-bold text-lg">Aucune carte</p>
            <p class="text-sm text-center mt-2 max-w-[200px]">Ajoutez vos cartes pour les sÃ©curiser hors ligne.</p>
        </div>
    </main>

    <!-- ADD BUTTON -->
    <button onclick="openCreator()" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-16 h-16 bg-white text-black rounded-full shadow-[0_0_50px_rgba(255,255,255,0.4)] flex items-center justify-center z-40 active:scale-90 transition-transform hover:rotate-90 duration-300">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
    </button>

    <!-- CREATOR MODAL -->
    <div id="creator-modal" class="fixed inset-0 z-50 bg-black flex flex-col hidden translate-y-full transition-transform duration-300">
        <div class="flex justify-between items-center p-6 border-b border-white/10 bg-black/50 backdrop-blur-md">
            <button onclick="closeCreator()" class="text-white/50 hover:text-white">Annuler</button>
            <h3 class="font-display font-bold text-lg">Nouvelle Carte</h3>
            <button onclick="saveCard()" class="text-brand-500 font-bold">Enregistrer</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8">
            
            <!-- Store Name & Logo Preview -->
            <div class="space-y-3">
                <label class="text-xs uppercase font-bold text-white/40 tracking-widest">Enseigne</label>
                <div class="relative">
                    <input type="text" id="input-store" oninput="detectLogo()" class="w-full glass rounded-xl p-4 pl-14 text-xl font-bold text-white outline-none focus:border-brand-500 transition-colors" placeholder="Ex: Ikea">
                    <div id="logo-preview-icon" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded bg-white/10 flex items-center justify-center overflow-hidden">
                        <span class="text-xs">?</span>
                    </div>
                </div>
                <!-- Quick Suggestions -->
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="quick-logos">
                    <!-- Logos injected via JS -->
                </div>
            </div>

            <!-- Card Image (Photo or Logo) -->
            <div class="space-y-3">
                <label class="text-xs uppercase font-bold text-white/40 tracking-widest">Visuel de la carte</label>
                
                <div class="grid grid-cols-2 gap-3">
                    <!-- Option 1: Use Logo -->
                    <div id="opt-logo" onclick="setVisualMode('logo')" class="glass rounded-xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer border-brand-500 bg-brand-500/10">
                        <span class="text-2xl">ðŸŽ¨</span>
                        <span class="text-xs font-bold">Utiliser le Logo</span>
                    </div>
                    <!-- Option 2: Upload Photo -->
                    <div id="opt-photo" onclick="triggerPhoto()" class="glass rounded-xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-white/5">
                        <span class="text-2xl">ðŸ“¸</span>
                        <span class="text-xs font-bold">Photo / Scan</span>
                    </div>
                </div>

                <!-- Preview Area -->
                <div id="visual-preview" class="w-full aspect-[1.586/1] rounded-xl bg-white/5 border border-white/10 overflow-hidden relative flex items-center justify-center mt-4">
                    <div id="preview-content" class="text-white/20 text-sm">AperÃ§u visuel</div>
                    <img id="final-image" class="absolute inset-0 w-full h-full object-cover hidden">
                </div>
            </div>

            <!-- Barcode -->
            <div class="space-y-3">
                <label class="text-xs uppercase font-bold text-white/40 tracking-widest">NumÃ©ro de carte</label>
                <div class="flex gap-2">
                    <input type="tel" id="input-code" class="w-full glass rounded-xl p-4 font-mono text-lg outline-none focus:border-brand-500" placeholder="Scannez ou tapez...">
                    <button onclick="generateRandom()" class="px-4 glass rounded-xl text-xl hover:bg-white/10">ðŸŽ²</button>
                </div>
                <div class="bg-white p-2 rounded-lg mt-2 opacity-50">
                    <svg id="preview-barcode" class="w-full h-12"></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- CROPPER STUDIO (Full Screen Overlay) -->
    <div id="cropper-modal" class="fixed inset-0 z-[60] bg-black hidden flex flex-col">
        <div class="absolute top-0 w-full p-4 z-10 flex justify-between">
            <button onclick="cancelCrop()" class="px-4 py-2 rounded-full bg-black/50 backdrop-blur text-white font-bold">Annuler</button>
            <h3 class="text-white font-bold mt-2 shadow-black drop-shadow-md">Ajustez la carte</h3>
            <button onclick="applyCrop()" class="px-4 py-2 rounded-full bg-white text-black font-bold">Valider</button>
        </div>
        
        <div id="crop-container" class="flex-1 relative bg-gray-900 overflow-hidden flex items-center justify-center">
            <!-- L'image Ã  recadrer -->
            <img id="image-to-crop" class="absolute transition-transform duration-0 origin-center" style="transform: translate(0px, 0px) scale(1);">
            
            <!-- Le masque (Overlay noir avec trou) -->
            <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
                <div class="w-[85vw] aspect-[1.586/1] rounded-2xl border-2 border-white/50 crop-overlay shadow-[0_0_0_100vh_rgba(0,0,0,0.8)]"></div>
            </div>
            
            <p class="absolute bottom-10 text-white/50 text-xs pointer-events-none">Glissez pour dÃ©placer â€¢ Pincez pour zoomer</p>
        </div>
    </div>
    
    <!-- Hidden File Input -->
    <input type="file" id="file-input" accept="image/*" class="hidden">

    <!-- VIEWER MODAL (Full Screen) -->
    <div id="viewer" class="fixed inset-0 z-50 bg-black hidden flex flex-col items-center justify-center">
        <button onclick="closeViewer()" class="absolute top-6 right-6 w-12 h-12 bg-white/10 rounded-full text-white z-20 flex items-center justify-center backdrop-blur text-xl">âœ•</button>
        
        <!-- Brightness Trick -->
        <div class="absolute top-6 left-6 text-xs text-brand-500 bg-brand-500/10 px-3 py-1 rounded-full border border-brand-500/20 animate-pulse">
            ðŸ”† LuminositÃ© Max
        </div>

        <div class="w-full max-w-md p-6 flex flex-col gap-8 items-center relative z-10">
            <h2 id="view-title" class="text-5xl font-display font-bold text-center text-transparent bg-clip-text bg-gradient-to-b from-white to-white/50">Titre</h2>
            
            <!-- Visual -->
            <div class="w-full aspect-[1.586/1] rounded-2xl overflow-hidden shadow-[0_0_50px_rgba(255,255,255,0.15)] border border-white/20 relative group">
                <img id="view-img" class="w-full h-full object-cover">
                <div id="view-logo-container" class="absolute inset-0 bg-white flex items-center justify-center p-8 hidden">
                    <!-- Logo injectÃ© ici -->
                </div>
            </div>

            <!-- Barcode -->
            <div class="w-full bg-white p-6 rounded-3xl shadow-2xl transform scale-110">
                <svg id="view-barcode" class="w-full h-24"></svg>
            </div>
            <p id="view-code" class="font-mono text-xl tracking-[0.2em] text-white/60"></p>

            <button onclick="deleteCard()" class="mt-8 text-red-500 text-xs uppercase font-bold tracking-widest border border-red-900 px-6 py-3 rounded-xl bg-red-500/5 hover:bg-red-500/20 transition">
                Supprimer la carte
            </button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA : LOGO DB (SVG STRINGS) ---
        // Top 20 France + Generic fallback
        const LOGOS = {
            'fnac': '<svg viewBox="0 0 100 100" fill="#EAB308"><rect width="100" height="100"/><path fill="black" d="M20 30h15v40h-15z M45 30h15v15h10v-15h15v40h-15v-15h-10v15h-15z"/></svg>',
            'carrefour': '<svg viewBox="0 0 100 100" fill="#003399"><rect width="100" height="100" fill="white"/><path d="M50 10 L90 50 L50 90 L10 50 Z" fill="#003399"/><circle cx="50" cy="50" r="35" fill="white"/><path d="M45 35h10v30h-10z" fill="#EF4444"/><path d="M30 50l15-15v30z" fill="#003399"/></svg>',
            'leclerc': '<svg viewBox="0 0 100 100" fill="#0066CC"><rect width="100" height="100"/><circle cx="50" cy="50" r="30" stroke="orange" stroke-width="5" fill="none"/><text x="50" y="65" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="40">L</text></svg>',
            'decathlon': '<svg viewBox="0 0 100 100" fill="#0082C3"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="20">DECATHLON</text></svg>',
            'ikea': '<svg viewBox="0 0 100 100" fill="#0051BA"><rect width="100" height="100"/><ellipse cx="50" cy="50" rx="45" ry="30" fill="#FFDA1A"/><text x="50" y="60" text-anchor="middle" fill="#0051BA" font-family="Arial" font-weight="bold" font-size="30">IKEA</text></svg>',
            'action': '<svg viewBox="0 0 100 100" fill="#009EE3"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-weight="bold" font-size="25">ACTION</text></svg>',
            'lidl': '<svg viewBox="0 0 100 100" fill="#0050AA"><rect width="100" height="100"/><rect x="10" y="10" width="80" height="80" fill="#FFF000"/><circle cx="50" cy="50" r="35" fill="#E60000"/><text x="50" y="60" text-anchor="middle" fill="#0050AA" font-weight="bold" font-size="30" font-style="italic">LiDL</text></svg>',
            'sephora': '<svg viewBox="0 0 100 100" fill="black"><rect width="100" height="100"/><path d="M20 50 Q50 10 80 50" stroke="white" stroke-width="2" fill="none"/><text x="50" y="70" text-anchor="middle" fill="white" letter-spacing="2">SEPHORA</text></svg>',
            'auchan': '<svg viewBox="0 0 100 100" fill="white"><rect width="100" height="100"/><path d="M50 20 L30 80 h40 Z" fill="#E2001A"/><path d="M50 25 L40 60 h20 Z" fill="#008C44"/></svg>',
            'leroy': '<svg viewBox="0 0 100 100" fill="#78BE20"><path d="M10 30 L50 10 L90 30 v50 L50 90 L10 80 Z"/></svg>',
            'generic': '<svg viewBox="0 0 100 100" fill="#333"><rect width="100" height="100"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="50">?</text></svg>'
        };

        // --- STATE ---
        let cards = JSON.parse(localStorage.getItem('wikimind_ult_cards')) || [];
        let visualMode = 'logo'; // 'logo' or 'photo'
        let currentPhotoBlob = null;
        let cropState = { img: null, scale: 1, x: 0, y: 0, startX:0, startY:0, isDragging: false };
        let currentViewId = null;

        // --- INIT ---
        window.onload = () => {
            renderGrid();
            initQuickLogos();
            document.getElementById('input-code').addEventListener('input', updateBarcodePreview);
        };

        function saveCards() {
            try {
                localStorage.setItem('wikimind_ult_cards', JSON.stringify(cards));
                renderGrid();
            } catch (e) { alert("MÃ©moire pleine ! Supprimez des cartes."); }
        }

        // --- RENDER GRID ---
        function renderGrid() {
            const grid = document.getElementById('grid');
            const search = document.getElementById('search').value.toLowerCase();
            grid.innerHTML = '';
            
            const filtered = cards.filter(c => c.store.toLowerCase().includes(search));
            
            if(filtered.length === 0 && !search) document.getElementById('empty').classList.remove('hidden');
            else document.getElementById('empty').classList.add('hidden');

            filtered.forEach(card => {
                const el = document.createElement('div');
                el.className = 'relative aspect-[1.586/1] rounded-2xl overflow-hidden cursor-pointer shadow-lg border border-white/10 group';
                el.onclick = () => openViewer(card.id);
                
                let visualHtml = '';
                if(card.type === 'logo') {
                    // Render Logo (Secure SVG injection)
                    const svg = LOGOS[card.logoKey] || LOGOS['generic'];
                    visualHtml = `<div class="w-full h-full bg-white flex items-center justify-center p-4">${svg}</div>`;
                } else {
                    // Render Photo
                    visualHtml = `<img src="${card.image}" class="w-full h-full object-cover">`;
                }

                el.innerHTML = `
                    ${visualHtml}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-80"></div>
                    <div class="absolute bottom-3 left-3">
                        <h3 class="font-bold text-white text-lg leading-none">${card.store}</h3>
                        <p class="text-[10px] text-white/60 font-mono mt-1">${card.number}</p>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        document.getElementById('search').addEventListener('input', renderGrid);

        // --- CREATOR LOGIC ---
        function openCreator() {
            document.getElementById('creator-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('creator-modal').classList.remove('translate-y-full'), 10);
            resetCreator();
        }
        function closeCreator() {
            document.getElementById('creator-modal').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('creator-modal').classList.add('hidden'), 300);
        }
        function resetCreator() {
            document.getElementById('input-store').value = '';
            document.getElementById('input-code').value = '';
            currentPhotoBlob = null;
            setVisualMode('logo');
            detectLogo();
        }

        function setVisualMode(mode) {
            visualMode = mode;
            const logoBtn = document.getElementById('opt-logo');
            const photoBtn = document.getElementById('opt-photo');
            const previewImg = document.getElementById('final-image');
            const previewTxt = document.getElementById('preview-content');

            if(mode === 'logo') {
                logoBtn.classList.add('border-brand-500', 'bg-brand-500/10');
                photoBtn.classList.remove('border-brand-500', 'bg-brand-500/10');
                previewImg.classList.add('hidden');
                previewTxt.innerText = "Sera gÃ©nÃ©rÃ© automatiquement";
                detectLogo();
            } else {
                photoBtn.classList.add('border-brand-500', 'bg-brand-500/10');
                logoBtn.classList.remove('border-brand-500', 'bg-brand-500/10');
                if(currentPhotoBlob) {
                    previewImg.src = currentPhotoBlob;
                    previewImg.classList.remove('hidden');
                } else {
                    previewTxt.innerText = "En attente de photo...";
                }
            }
        }

        // --- AUTO LOGO SYSTEM ---
        function detectLogo() {
            const input = document.getElementById('input-store').value.toLowerCase();
            const iconContainer = document.getElementById('logo-preview-icon');
            let match = 'generic';

            for (const key in LOGOS) {
                if (input.includes(key)) match = key;
            }
            
            iconContainer.innerHTML = LOGOS[match];
            
            // Si mode logo actif, mettre Ã  jour la preview
            if(visualMode === 'logo') {
                 const previewContent = document.getElementById('preview-content');
                 previewContent.innerHTML = `<div class="w-24 h-24">${LOGOS[match]}</div>`;
            }
            return match;
        }

        function initQuickLogos() {
            const container = document.getElementById('quick-logos');
            const top = ['carrefour', 'leclerc', 'fnac', 'decathlon', 'ikea'];
            top.forEach(key => {
                const btn = document.createElement('div');
                btn.className = "w-10 h-10 rounded-full bg-white p-1 flex-shrink-0 cursor-pointer border-2 border-transparent hover:border-brand-500";
                btn.innerHTML = LOGOS[key];
                btn.onclick = () => {
                    document.getElementById('input-store').value = key.charAt(0).toUpperCase() + key.slice(1);
                    detectLogo();
                };
                container.appendChild(btn);
            });
        }

        // --- PHOTO & CROPPER ---
        function triggerPhoto() {
            document.getElementById('file-input').click();
        }

        document.getElementById('file-input').addEventListener('change', function(e) {
            if(e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => startCropper(evt.target.result);
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        function startCropper(src) {
            const modal = document.getElementById('cropper-modal');
            const img = document.getElementById('image-to-crop');
            
            modal.classList.remove('hidden');
            img.src = src;
            
            // Reset transforms
            cropState = { scale: 1, x: 0, y: 0 };
            updateTransform();

            // Touch Events
            const container = document.getElementById('crop-container');
            
            // Simple logic for drag/pan (Pinch zoom requires libraries, here using simple wheel/buttons logic equivalent)
            // For this single file, we implement basic Pan.
            let isDown = false;
            let startX, startY;

            container.onmousedown = container.ontouchstart = (e) => {
                isDown = true;
                const p = e.touches ? e.touches[0] : e;
                startX = p.clientX - cropState.x;
                startY = p.clientY - cropState.y;
            };

            window.onmouseup = window.ontouchend = () => isDown = false;

            window.onmousemove = window.ontouchmove = (e) => {
                if(!isDown) return;
                e.preventDefault();
                const p = e.touches ? e.touches[0] : e;
                cropState.x = p.clientX - startX;
                cropState.y = p.clientY - startY;
                updateTransform();
            };
            
            // Add zoom via wheel
            container.onwheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                cropState.scale *= delta;
                updateTransform();
            }
        }

        function updateTransform() {
            const img = document.getElementById('image-to-crop');
            img.style.transform = `translate(${cropState.x}px, ${cropState.y}px) scale(${cropState.scale})`;
        }

        function cancelCrop() {
            document.getElementById('cropper-modal').classList.add('hidden');
            document.getElementById('file-input').value = '';
        }

        function applyCrop() {
            // Draw current view to canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = document.getElementById('image-to-crop');
            const container = document.getElementById('crop-container');
            
            // Target dimensions (Card Ratio)
            const w = 800; 
            const h = 505; // 1.58 ratio
            canvas.width = w;
            canvas.height = h;

            // Calculate draw params
            // This is a simplified "What you see is what you get" crop logic
            // We essentially screenshot the center of the div
            // Note: For perfect precision without libraries, we approximate based on the transform
            
            // Better approach for simple code: Draw the image centered and transformed
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0,w,h);
            
            ctx.translate(w/2, h/2);
            ctx.translate(cropState.x, cropState.y);
            ctx.scale(cropState.scale, cropState.scale);
            ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);

            currentPhotoBlob = canvas.toDataURL('image/jpeg', 0.8);
            
            // Close & Update UI
            document.getElementById('cropper-modal').classList.add('hidden');
            setVisualMode('photo');
        }

        // --- BARCODE GEN ---
        function updateBarcodePreview() {
            const val = document.getElementById('input-code').value;
            try {
                JsBarcode("#preview-barcode", val || "1234", {
                    format: "CODE128", displayValue: false, height: 40, margin: 0, width: 2
                });
            } catch(e) {}
        }
        function generateRandom() {
            document.getElementById('input-code').value = Math.floor(Math.random() * 1000000000000);
            updateBarcodePreview();
        }

        // --- SAVE ---
        function saveCard() {
            const store = document.getElementById('input-store').value;
            const number = document.getElementById('input-code').value || "000000";
            
            if(!store) return alert("Nom requis");

            let cardData = {
                id: Date.now(),
                store,
                number,
                type: visualMode
            };

            if(visualMode === 'logo') {
                cardData.logoKey = detectLogo();
            } else {
                cardData.image = currentPhotoBlob;
            }

            cards.push(cardData);
            saveCards();
            closeCreator();
        }

        // --- VIEWER ---
        function openViewer(id) {
            currentViewId = id;
            const card = cards.find(c => c.id === id);
            if(!card) return;

            const modal = document.getElementById('viewer');
            document.getElementById('view-title').innerText = card.store;
            document.getElementById('view-code').innerText = card.number;

            const imgEl = document.getElementById('view-img');
            const logoCont = document.getElementById('view-logo-container');

            if(card.type === 'logo') {
                imgEl.classList.add('hidden');
                logoCont.classList.remove('hidden');
                logoCont.innerHTML = LOGOS[card.logoKey] || LOGOS['generic'];
            } else {
                logoCont.classList.add('hidden');
                imgEl.classList.remove('hidden');
                imgEl.src = card.image;
            }

            JsBarcode("#view-barcode", card.number, {
                format: "CODE128", displayValue: false, height: 100, margin: 10, width: 3
            });

            modal.classList.remove('hidden');
        }

        function closeViewer() {
            document.getElementById('viewer').classList.add('hidden');
        }

        function deleteCard() {
            if(confirm("Supprimer ?")) {
                cards = cards.filter(c => c.id !== currentViewId);
                saveCards();
                closeViewer();
            }
        }
    </script>
</body>
</html>
